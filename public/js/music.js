var base="https://unacceptableuse.com/petify/";var app=angular.module("music",["rzModule","ngAria"]);function debounce(func,wait,immediate){var timeout;return function(){var context=this,args=arguments;var later=function(){timeout=null;if(!immediate)func.apply(context,args)};var callNow=immediate&&!timeout;clearTimeout(timeout);timeout=setTimeout(later,wait);if(callNow)func.apply(context,args)}}function throttle(fn,threshhold,scope){threshhold||(threshhold=250);var last,deferTimer;return function(){var context=scope||this;var now=+new Date,args=arguments;if(last&&now<last+threshhold){clearTimeout(deferTimer);deferTimer=setTimeout(function(){last=now;fn.apply(context,args)},threshhold)}else{last=now;fn.apply(context,args)}}}Array.prototype.move=function(from,to){this.splice(to,0,this.splice(from,1)[0]);return this};document.head=document.head||document.getElementsByTagName("head")[0];function changeFavicon(src){var link=document.createElement("link"),oldLink=document.getElementById("dynamic-favicon");link.id="dynamic-favicon";link.rel="shortcut icon";link.href=src;if(oldLink){document.head.removeChild(oldLink)}document.head.appendChild(link)}app.config(function($interpolateProvider,$locationProvider){$interpolateProvider.startSymbol("{[{");$interpolateProvider.endSymbol("}]}");$locationProvider.html5Mode({enabled:true,rewriteLinks:false})});app.filter("secondsToDateTime",[function(){return function(seconds){return new Date(1970,0,1).setSeconds(seconds)}}]);app.filter("integer",function(){return function(input){return parseInt(input)}});app.directive("ngRightClick",function($parse){return function(scope,element,attrs){var fn=$parse(attrs.ngRightClick);element.bind("contextmenu",function(event){scope.$apply(function(){event.preventDefault();fn(scope,{$event:event})})})}});const websocketBase="wss://unacceptableuse.com/petify/ws";function initialiseWebsocket($rootScope){$rootScope.serverIssues=false;$rootScope.messages=[];setInterval(function(){$rootScope.messages.forEach(function(message,index){message.lifetime--;if(message.lifetime<=0){$(".message[data-index="+index+"]").fadeOut(400,function(){$rootScope.messages.splice(index,1);console.log($rootScope.messages)})}})},1e3);$rootScope.updateSocket=new WebSocket(websocketBase+"/updates");$rootScope.updateSocket.onerror=function(err){console.error("Websocket disconnected... Retrying in 2 seconds");$rootScope.serverIssues=true;$rootScope.$apply();console.log($rootScope.serverIssues);setTimeout(function(){initialiseWebsocket($rootScope)},2e3)};$rootScope.updateSocket.onopen=function(){console.log("Connected");$rootScope.serverIssues=false};$rootScope.updateSocket.onmessage=function(message){var data=JSON.parse(message.data);if(data&&data.type&&data.message){switch(data.type){case"alert":$rootScope.messages.push(data.message)}}}}app.run(["$rootScope",function($rootScope){$("#albumArt").error(function(){$(this).attr("src","img/album.png")});$(document).bind("mousedown",function(e){if(!$(e.target).parents(".contextMenu").length>0)$(".contextMenu").hide(100)});$rootScope.progressBar={options:{showSelectionBar:true,ceil:100,floor:0,onChange:function(unk1,val,unk2,unk3){$rootScope.audioPlayer.currentTime=val},translate:function(){return""}},volumeOptions:{showSelectionBar:true,ceil:1,step:.01,hideLimitLabels:true,precision:2,floor:0,translate:function(val){return parseInt(val*100)+"%"}}};$rootScope.settings={shuffle:true,repeat:false,autoplay:true};$rootScope.nowPlaying={artist:"Nobody",album:null,id:null,artistID:null,title:"Nothing",duration:0,normalPlay:false,elapsed:0,playing:false,buffered:0,buffering:false};$rootScope.queue=[];$rootScope.getSongById=function(id){return $(".song[data-id='"+id+"']").get(0)};$rootScope.addToQueueById=function(id){$rootScope.addToQueue($rootScope.getSongById(id))};$rootScope.addToQueue=function(element){var info=element.outerText.split(" - ");var songObject={artist:info[0],title:info[1],id:element.attributes["data-id"].value,album:element.attributes["data-album"].value,artistID:element.attributes["data-artist"].value};$rootScope.queue.push(songObject)};$rootScope.queueNextById=function(id){$rootScope.queueNext($rootScope.getSongById(id))};$rootScope.queueNext=function(element){var info=element.outerText.split(" - ");var songObject={artist:info[0],title:info[1],id:element.attributes["data-id"].value,album:element.attributes["data-album"].value,artistID:element.attributes["data-artist"].value};$rootScope.queue.unshift(songObject)};$rootScope.removeFromQueue=function(index){$rootScope.queue.splice(index,1)};$rootScope.queueMoveUp=function(index){$rootScope.queue.move(index,index-1)};$rootScope.queueMoveDown=function(index){$rootScope.queue.move(index,index+1)};$rootScope.audioPlayer=new Audio;$rootScope.audioPlayer.onerror=function(){console.error("Error: "+audioPlayer.error.code)};$rootScope.audioPlayer.oncanplay=function(){$rootScope.nowPlaying.normalPlay=false;console.log("Can play");$rootScope.audioPlayer.play()};$rootScope.audioPlayer.onplaying=function(){$rootScope.nowPlaying.playing=true;console.log("playing")};$rootScope.audioPlayer.ontimeupdate=function(){$rootScope.nowPlaying.elapsed=$rootScope.audioPlayer.currentTime;$rootScope.$apply();$rootScope.nowPlaying.buffering=false;$rootScope.nowPlaying.normalPlay=$rootScope.audioPlayer.currentTime>1};$rootScope.audioPlayer.onpause=function(){$rootScope.nowPlaying.playing=false};$rootScope.audioPlayer.onloadeddata=function(){console.log("No longer buffering");$rootScope.nowPlaying.buffering=false};$rootScope.audioPlayer.ondurationchange=function(){$rootScope.nowPlaying.duration=$rootScope.audioPlayer.duration;$rootScope.progressBar.options.ceil=parseInt($rootScope.nowPlaying.duration);$rootScope.nowPlaying.normalPlay=false};$rootScope.audioPlayer.onstalled=function(){console.log("Buffering");$rootScope.nowPlaying.buffering=true};$rootScope.audioPlayer.onvolumechange=function(){console.log("Aye lad the volume changed")};$rootScope.audioPlayer.onended=function(){if($rootScope.settings.autoplay){if($rootScope.settings.repeat)$rootScope.audioPlayer.currentTime=0;else $rootScope.playNext()}};$rootScope.playNext=function playNext(){$rootScope.nowPlaying.normalPlay=false;if($rootScope.queue.length>0){var nextSong=$rootScope.queue.shift();$rootScope.playById(nextSong.id)}else{var availableSongs=$(".songList.playable:visible .song");$rootScope.playByElement(availableSongs[parseInt(Math.random()*availableSongs.length)])}$rootScope.audioPlayer.play()};$rootScope.playById=function playById(id){$rootScope.playByElement($rootScope.getSongById(id))};$rootScope.playByElement=function playByElement(element){if(!element)return console.warn("Warning: playByElement called with a null element! Bad ID somewhere?");$(".songRate").removeClass("rated");var info=element.outerText.split(" - ");$rootScope.nowPlaying.id=element.attributes["data-id"].value;$rootScope.nowPlaying.artistID=element.attributes["data-artist"].value;$rootScope.nowPlaying.artist=info[0];$rootScope.nowPlaying.title=info[1];$rootScope.nowPlaying.buffering=true;$rootScope.audioPlayer.src=base+"song/"+element.attributes["data-id"].value;$("#albumArt").attr("src",base+"album/"+element.attributes["data-album"].value);if(window.innerWidth<=1111){changeFavicon(base+"album/"+element.attributes["data-album"].value);document.title=info[0]+" - "+info[1]}};initialiseWebsocket($rootScope)}]);app.controller("AdminController",function($scope,$rootScope,$sce,$templateRequest,$compile,$http){$scope.showErrorScreen=function(error){$scope.error=error;$templateRequest("error").then(function(template){$compile($("#tabContainer").html(template).contents())($scope)},function(error){console.error("Well shit "+error)})};$scope.createAdminView=function(type){$templateRequest("loading").then(function(template){$compile($("#tabContainer").html(template).contents())($scope)},$scope.showErrorScreen);var templateUrl=$sce.getTrustedResourceUrl("templates/admin/"+type);$templateRequest(templateUrl).then(function(template){$compile($("#tabContainer").html(template).contents())($scope)},$scope.showErrorScreen)};$scope.alert={url:base+"img/album.png",users:{},title:"",body:"",lifetime:5};$scope.sendAlert=function(){$http.post(base+"templates/admin/alerts",$scope.alert).then(function(resp){$scope.error=resp.data.error})}});app.controller("AddController",function($scope,$templateRequest,$sce,$compile,$http){$scope.addViews={playlist:"playlist",song:"song#"+Math.random(),radio:"radio"};$scope.showErrorScreen=function(error){$scope.error=error;$templateRequest("error").then(function(template){$compile($("#tabContainer").html(template).contents())($scope)},function(error){console.error("Well shit "+error)})};$scope.addSong=function(){console.log($scope.song);$http.post(base+"templates/add/song",$scope.song).then(function(response){if(!response.data.err){console.log("Aye aye cpn");var templateUrl=$sce.getTrustedResourceUrl("templates/add/song#"+Math.random());$templateRequest(templateUrl).then(function(template){$compile($("#tabContainer").html(template).contents())($scope)},$scope.showErrorScreen)}else{$scope.err=response.data.err}},function(err){$scope.err=err;console.log("There was an error: "+err)})};$scope.clearFailed=function(){$http.get(base+"templates/delete/downloadQueue/allFailed").then(function(){var templateUrl=$sce.getTrustedResourceUrl("templates/add/song#"+Math.random());$templateRequest(templateUrl).then(function(template){$compile($("#tabContainer").html(template).contents())($scope)},$scope.showErrorScreen)})};$scope.createAddView=function(type){$templateRequest("loading").then(function(template){$compile($("#tabContainer").html(template).contents())($scope)},$scope.showErrorScreen);var templateUrl=$sce.getTrustedResourceUrl("templates/add/"+$scope.addViews[type]);$templateRequest(templateUrl).then(function(template){$compile($("#tabContainer").html(template).contents())($scope)},$scope.showErrorScreen)}});app.controller("AddPlaylistController",function($scope,$http){$scope.checkAll=function(){$(".songSelect").prop("checked",true)};$scope.uncheckAll=function(){$(".songSelect").prop("checked",false)};$scope.invertAll=function(){$(".songSelect").prop("checked",function(_,checked){return!checked})};$scope.createPlaylist=function(){$http.post(base+"templates/add/playlist",$scope.playlist).then(function(response){if(!response.data.err){$scope.$emit("switchTab",4)}else{$scope.err=response.data.err}},function(err){$scope.err=err;console.log("There was an error: "+err)})}});app.controller("AddToPlaylistController",function($scope,$http){$scope.selectedPlaylist=null;$scope.selectPlaylist=function(id){$scope.selectedPlaylist=id;console.log("Selected playlist is now "+$scope.selectedPlaylist)};$scope.addSongToPlaylist=function(id){console.log("Btuton pressed");if($scope.selectedPlaylist){$http.post(base+"templates/add/playlist/"+$scope.selectedPlaylist+"/addSong/"+id);$scope.$emit("closeModal")}else{console.log("selectedPlaylist is "+$scope.selectedPlaylist)}}});app.controller("ContextMenuController",function($scope,$rootScope){$scope.ctxPlayNext=function(event){var contextMenu=$("#songContextMenu");$rootScope.queueNextById(contextMenu.data("id"));contextMenu.toggle(100)};$scope.ctxAddToQueue=function(event){var contextMenu=$("#songContextMenu");$rootScope.addToQueueById(contextMenu.data("id"));contextMenu.toggle(100)};$scope.ctxAddToPlaylist=function(event){var contextMenu=$("#songContextMenu");$rootScope.$emit("openModal","modals/addToPlaylist/"+contextMenu.data("id"),false);contextMenu.toggle(100)};$scope.ctxSongInfo=function(event){var contextMenu=$("#songContextMenu");$rootScope.$emit("openModal","modals/songInfo/"+contextMenu.data("id"),false);contextMenu.toggle(100)};$scope.ctxViewAlbum=function(){var contextMenu=$("#songContextMenu");$rootScope.$emit("showSongList","album/"+contextMenu.data("album"),false);contextMenu.toggle(100)};$scope.ctxViewArtist=function(){var contextMenu=$("#songContextMenu");$rootScope.$emit("showSongList","artist/"+contextMenu.data("artist"),false);contextMenu.toggle(100)}});app.controller("PlaylistController",function($scope,$rootScope,$http){$scope.deletePlaylist=function(id){$rootScope.$emit("openModal","delete/playlist/"+id)};$scope.deletePlaylistForReal=function(id){$http.get(base+"templates/delete/playlist/"+id+"/confirmed");$rootScope.$emit("closeModal");$rootScope.$emit("switchTab",4)}});app.controller("ModalController",function($scope,$rootScope,$sce,$templateRequest,$compile){$templateRequest("loading").then(function(template){$compile($("#modalBox").html(template).contents())($scope)},$scope.showErrorScreen);$scope.showErrorScreen=function(error){$scope.error=error;$templateRequest("error").then(function(template){$compile($("#modalBox").html(template).contents())($scope)},function(error){console.error("Well shit "+error)})};$scope.openModal=function(path,nocache){$("#modalShadow").addClass("modal-visible");$templateRequest("loading").then(function(template){$compile($("#modalBox").html(template).contents())($scope)},$scope.showErrorScreen);var templateUrl=$sce.getTrustedResourceUrl("templates/"+path+(nocache?"#"+Math.random():""));$templateRequest(templateUrl).then(function(template){$compile($("#modalBox").html(template).contents())($scope)},$scope.showErrorScreen)};$scope.closeModal=function(){$("#modalShadow").removeClass("modal-visible")};$rootScope.$on("openModal",function(evt,path,nocache){console.log("Received openmodal event");$scope.openModal(path,nocache)});$rootScope.$on("closeModal",$scope.closeModal);$("#modalShadow").click(function(e){if(e.target!=this)return;$scope.closeModal()})});app.controller("SongController",function($scope,$rootScope,$sce,$templateRequest,$compile,$http,$location){$scope.playSong=function(event){$rootScope.playByElement(event.target)};$scope.showSongContextMenu=function(event){$("#songContextMenu").finish().toggle(100).css({left:event.pageX,top:event.pageY,display:"absolute"}).data("id",event.target.attributes["data-id"].value).data("artist",event.target.attributes["data-artist"].value).data("album",event.target.attributes["data-album"].value)};$scope.togglePlaying=function(){console.log("Toggling??");if($rootScope.audioPlayer.paused)$rootScope.audioPlayer.play();else $rootScope.audioPlayer.pause()};$scope.showErrorScreen=function(error){$scope.error=error;$templateRequest("error").then(function(template){$compile($("#tabContainer").html(template).contents())($scope)},function(error){console.error("Well shit "+error)})};$scope.showSongList=function(template){$templateRequest("loading").then(function(template){$compile($("#tabContainer").html(template).contents())($scope)},$scope.showErrorScreen);var templateUrl=$sce.getTrustedResourceUrl("templates/songs/"+template+"#"+Math.random());$templateRequest(templateUrl).then(function(template){$compile($("#tabContainer").html(template).contents())($scope)},$scope.showErrorScreen)};$scope.playArtist=function(id){$scope.showSongList("artist/"+id)};$scope.playAlbum=function(id){$scope.showSongList("album/"+id)};$scope.playPlaylist=function(id){$location.path("/playlist/"+id);$scope.showSongList("playlist/"+id)};$scope.playGenre=function(id){$scope.showSongList("genre/"+id)};$scope.skipSong=function(){ga("send","event","Song","Skip",$rootScope.nowPlaying.id,$rootScope.nowPlaying.elapsed);$scope.playNext()};$scope.rateSongUp=debounce(function(){$http({method:"PUT",url:"song/"+$rootScope.nowPlaying.id+"/vote/up"});$(".songRate").removeClass("rated");$("#songRateUp").addClass("rated")},1e3,true);$scope.rateSongDown=debounce(function(){$http({method:"PUT",url:"song/"+$rootScope.nowPlaying.id+"/vote/down"});$(".songRate").removeClass("rated");$("#songRateDown").addClass("rated")},1e3,true);$rootScope.$on("showSongList",function(evt,arg){$scope.showSongList(arg)})});app.controller("TabController",function($scope,$templateRequest,$sce,$compile,$rootScope,$location){console.log("TAB CONTROLLER STARTED");$scope.tabs=[{name:"Songs",icon:"fa-music",template:"songs",location:"songs","default":"selected"},{name:"Artists",icon:"fa-user",location:"artists",template:"artists"},{name:"Albums",icon:"fa-square",location:"albums",template:"albums"},{name:"Genres",icon:"fa-list",location:"genres",template:"genres"},{name:"Playlists",icon:"fa-th-list",location:"playlists",template:"playlists",nocache:true},{name:"Radio",icon:"fa-fast-forward",location:"radio",template:"radio",nocache:true},{name:"Add",icon:"fa-plus",location:"add",template:"add"},{name:"Stats",icon:"fa-area-chart",location:"stats",template:"stats"}];if($rootScope.userLevel>=2)$scope.tabs.push({name:"Admin",icon:"fa-lock",location:"admin",template:"admin"});if($rootScope.christmas){$scope.tabs.splice(4,0,{name:"Christmas",icon:"fa-tree",location:"",template:"songs/genre/aeb54483-0fa8-4a52-b394-bc021fe01021"})}$templateRequest("loading").then(function(template){$("#tabContainer").html(template)},$scope.showErrorScreen);$scope.showErrorScreen=function(error){$scope.error=error;$templateRequest("error").then(function(template){$compile($("#tabContainer").html(template).contents())($scope)},function(error){console.error("Well shit "+error)})};$scope.search=debounce(function(){var query=$("#searchBar").find(".search").val();if(query&&query.length>0){var templateUrl=$sce.getTrustedResourceUrl("search/template/"+query+"#"+Math.random());$templateRequest(templateUrl).then(function(template){$compile($("#tabContainer").html(template).contents())($scope)},$scope.showErrorScreen)}else{$scope.switchTab($scope.tabs[0])}},150);$scope.showAddPlaylist=function(){$templateRequest("loading").then(function(template){$compile($("#tabContainer").html(template).contents())($scope)},$scope.showErrorScreen);var templateUrl=$sce.getTrustedResourceUrl("templates/add/playlist");$templateRequest(templateUrl).then(function(template){$compile($("#tabContainer").html(template).contents())($scope)},$scope.showErrorScreen)};$scope.tabSwitching=false;$scope.switchTab=function(tab){console.trace();if($scope.tabSwitching)return console.warn("Tried to switch tab whilst tab was switching");$scope.tabSwitching=true;for(var i in $scope.tabs)if($scope.tabs.hasOwnProperty(i))$scope.tabs[i].default=null;tab.default="selected";$templateRequest("loading").then(function(template){$("#tabContainer").html(template)},$scope.showErrorScreen);var templateUrl=$sce.getTrustedResourceUrl("templates/"+tab.template+(tab.nocache?"#"+Math.random():""));$templateRequest(templateUrl).then(function(template){$compile($("#tabContainer").html(template).contents())($scope);$scope.tabSwitching=false},$scope.showErrorScreen);console.log("Setting location "+$location.path());$location.path("/"+tab.location);if(window.innerWidth<=1111)$(".hamburger").prop("checked",false)};$scope.$on("switchTab",function(evt,tab){$scope.switchTab($scope.tabs[tab])});$rootScope.$on("switchTab",function(evt,tab){$scope.switchTab($scope.tabs[tab])});$rootScope.$emit("tabControllerReady")});app.controller("SongInfoTabController",function($scope,$templateRequest,$sce,$compile,$rootScope,$http){$scope.songId=$("#songInfoContainer").data("id");$scope.tabs=[{name:"Playlists",icon:"fa-list",template:"playlists",mode:"selected"}];if($rootScope.userLevel>=2){$scope.tabs.push({name:"Replace",icon:"fa-copy",template:"replace",cssClass:"userlevel-2"});$scope.tabs.push({name:"Edit",icon:"fa-pencil",template:"edit",cssClass:"userlevel-2"});$scope.tabs.push({name:"Technical",icon:"fa-code",template:"technical",cssClass:"userlevel-2"})}if($rootScope.userLevel>=3){$scope.tabs.push({name:"Delete",icon:"fa-trash",template:"delete",cssClass:"userlevel-3"})}$templateRequest("loading").then(function(template){$compile($("#modalTabContainer").html(template).contents())($scope)},$scope.showErrorScreen);$scope.showErrorScreen=function(error){$scope.error=error;$templateRequest("error").then(function(template){$compile($("#modalTabContainer").html(template).contents())($scope)},function(error){console.error("Well shit "+error)})};$scope.switchTab=function(tab){for(var i in $scope.tabs)if($scope.tabs.hasOwnProperty(i))$scope.tabs[i].mode=null;tab.mode="selected";$templateRequest("loading").then(function(template){$compile($("#modalTabContainer").html(template).contents())($scope)},$scope.showErrorScreen);var templateUrl=$sce.getTrustedResourceUrl("templates/modals/songInfo/"+$scope.songId+"/"+tab.template+(tab.nocache?"#"+Math.random():""));$templateRequest(templateUrl).then(function(template){$compile($("#modalTabContainer").html(template).contents())($scope)},$scope.showErrorScreen)};$scope.$on("switchSongInfoTab",function(evt,tab){$scope.switchTab($scope.tabs[tab])});$rootScope.$on("switchSongInfoTab",function(evt,tab){$scope.switchTab($scope.tabs[tab])});$scope.switchTab($scope.tabs[0]);$scope.deleteSong=function(id){$http.get(base+"templates/delete/song/"+id).then(function(resp){if(resp.data.error)$scope.error=error})}});app.controller("SettingsController",function($scope,$rootScope,$http){$http.get(base+"templates/settings/getAPIKey").then(function(data){$scope.settings.apiKey=data.data.id});$scope.regenerateKey=function(){$http.get(base+"templates/settings/generateAPIKey").then(function(data){if(data.data.err){console.error("fuck again "+data.err)}else{$scope.settings.apiKey=data.data.key}})}});